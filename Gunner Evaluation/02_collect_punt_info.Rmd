---
title: "2. Gathering Play Information"
output:
  html_document:
    df_print: paged
---
Later in my analysis, I will need some variables identifying important play information. I decided to process all the variables beforehand and save them to a .csv file for future use. This will save me from recalculating them multiple times in the future.

## 2.1 Imports
```{r warning=FALSE}
source("E:/R Projects/gunner_evaluation/R/00_source.R")


library(tidyverse)

puntPlays <- read.csv(paste0(wd$data, 'punt_plays1.csv'))
```

## 2.2 Create New Dataframe to Store Important Play Information
* **gameId:** Game identifier, unique (numeric)
* **playId:** Play identifier, not unique across games (numeric)
* **snapFrame:** Frame in tracking data that ball was snapped (numeric)
* **catchFrame:** Frame in tracking data that ball was caught (numeric)
* **kickDir:** Kick direction from kicking team's perspective (character)
  + Possible values:
    + **L:** Left
    + **R:** Right
    + **C:** Center
* **returnYds:** Yards gained by return team (numeric)
* **specialTeamsResult:** Special teams outcome of play (character)
```{r}
puntPlaysID <- unique(puntPlays[c('gameId', 'playId')])

puntPlayInfo <- data.frame(gameId = puntPlaysID$gameId,
                           playId = puntPlaysID$playId,
                           snapFrame = numeric(nrow(puntPlaysID)),
                           catchFrame = numeric(nrow(puntPlaysID)),
                           kickDir = character(nrow(puntPlaysID)),
                           returnYds = numeric(nrow(puntPlaysID)),
                           specialTeamsResult = character(nrow(puntPlaysID)))
```

## 2.3 Fill *snapFrame*, *catchFrame*, and *ballCatchRow* Columns
This is possible by using the *event* variable and checking which frame the 'ball_snap' event occurred. However, some plays don't have this event listed. Below we can see that almost every play has the ball being snapped at the eleventh frame. If the 'ball_snap' event doesn't exist, I will assume it happened at frame eleven. For filling the *catchFrame* column, I can check for events such as 'fair_catch', 'punt_received', or 'punt_land'. If none of these events exist, I can estimate it by adding the *snapFrame*, *operationTime*, and *hangTime* together. 

```{r}
ballSnapFrame <- puntPlays$frameId[puntPlays$event == 'ball_snap' &
                                   puntPlays$displayName == 'football']
table(ballSnapFrame)
```



```{r}
for (i in 1:nrow(puntPlayInfo)) {
  play <- puntPlays %>% filter(gameId == puntPlayInfo$gameId[i] & 
                                 playId == puntPlayInfo$playId[i])
  
  puntPlayInfo$snapFrame[i] <- play$frameId[which(play$event == 'ball_snap')][1]
  
  if (is.na(puntPlayInfo$snapFrame[i])) {
    puntPlayInfo$snapFrame[i] <- 11
  }
  
  catchFrameCands <- play$frameId[which(play$event == 'fair_catch' | 
                                        play$event == 'punt_received' |
                                        play$event == 'punt_land')]
  if(length(catchFrameCands) > 0) {
    puntPlayInfo$catchFrame[i] <- max(catchFrameCands)
  } else {
    puntPlayInfo$catchFrame[i] <- puntPlayInfo$snapFrame[i] + 
                                  ceiling(play$operationTime[1] * 10) + 
                                  ceiling(play$hangTime[1] * 10)
  }
}
```

```{r}
head(puntPlayInfo)
```

## 2.4 Fill *kickDir* Column
```{r}
for (i in 1:nrow(puntPlayInfo)) {
  play <- puntPlays %>% filter(gameId == puntPlayInfo$gameId[i] & 
                               playId == puntPlayInfo$playId[i])
  
  puntPlayInfo$kickDir[i] <- play$kickDirectionActual[1]
}
```

```{r}
head(puntPlayInfo)
```

## 2.5 Fill *returnYds* and *specialTeamResult* Columns
```{r}
returnYds <- numeric(nrow(puntPlayInfo))
for (i in 1:nrow(puntPlayInfo)) {
  play <- puntPlays %>% filter(gameId == puntPlayInfo$gameId[i] & 
                               playId == puntPlayInfo$playId[i])
  
  puntPlayInfo$specialTeamsResult[i] <- play$specialTeamsResult[1]
  returnYds[i] <- play$kickReturnYardage[1]
}
puntPlayInfo$returnYds <- returnYds
```

```{r}
head(puntPlayInfo)
```

## 2.6 Write to .csv
```{r}
write.csv(puntPlayInfo, paste0(wd$data, 'punt_play_info.csv'), row.names = FALSE)
```

